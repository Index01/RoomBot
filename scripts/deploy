#!/usr/bin/env bash

set -e

SCRIPTDIR=$( cd "${0%/*}" && pwd)
ROOTDIR="${SCRIPTDIR%/*}"
ENV_FILE="${ROOTDIR}/secrets.env"

problems() {
    2>&1 echo "Error: $*"
    exit 1
}

cleanup() {
    if [ -e "$ENV_FILE" ] ; then
	rm "$ENV_FILE"
    fi
}

usage() {
    echo "deploy <username> <hostname>"
    echo
    echo "this script will deploy the most recently built (local) artifact to the remote host"
    echo "it will perform migrations, restart services, and not make you a martini"
    exit 1
}

[ -e "${ROOTDIR}/secrets.env" ] && problems "plaintext secrets present"

trap cleanup EXIT

[ $# == 2 ] || usage

R_USER="$1"
R_HOST="$2"

scp "${SCRIPTDIR}/deploy-remote.sh" \
    "${R_USER}@${R_HOST}:/tmp/deploy.sh"
scp "${ROOTDIR}/build/roombaht-backend.tgz" \
    "${ROOTDIR}/build/roombaht-frontend.tgz" \
    "${R_USER}@${R_HOST}:/tmp"
"${SCRIPTDIR}/secrets" decrypt
scp "$ENV_FILE" "${R_USER}@${R_HOST}:/tmp/secrets.env"

ssh "${R_USER}@${R_HOST}" \
    "sudo bash /tmp/deploy.sh ; sudo rm /tmp/deploy.sh"

#!/usr/bin/env bash

set -e

SCRIPTDIR=$( cd "${0%/*}" && pwd)
ROOTDIR="${SCRIPTDIR%/*}"

problems() {
    2>&1 echo "Error: $*"
    exit 1
}

cleanup() {
    if [ -e "$ENV_FILE" ] ; then
	if [ -n "$SSH_HOST" ] ; then
	    ssh "$SSH_HOST" "sudo rm /tmp/secrets.env"
	fi
	rm "$ENV_FILE"
    fi

}

usage() {
    echo "roombaht_ctl <user> <hostname> <env> init <rooms dot csv> <staff dot csv>"
    echo "                             -f         force wipe, otherwise asks"
    echo
    echo "roombaht_ctl <user> <hostname> <env> frontend-log"
    echo "roombaht_ctl <user> <hostname> <env> backend-log"
    echo "roombaht_ctl <user> <hostname> <env> wipe"
}

trap cleanup EXIT

[ $# -lt 3 ] && ( usage ; exit 1 )

R_USER="$1"
R_ENV="$2"
ACTION="$3"
shift 3

ENV_FILE="${ROOTDIR}/secrets/${R_ENV}.env"
ENC_FILE="${ROOTDIR}/config/${R_ENV}.enc"

[ -e "$ENV_FILE" ] && problems "plaintext secrets present"
[ -e "$ENC_FILE" ] || problems "env file not found"

# keep it random, allows for multiple invocations
R_SCRIPT="/tmp/roombaht_ctl-remote-${RANDOM}.sh"
R_SECRET="/tmp/secrets-${RANDOM}.env"

# always copy secrets over and extract ssh host
"${SCRIPTDIR}/secrets" decrypt "$R_ENV"
source "$ENV_FILE"
[ -n "$ROOMBAHT_HOST" ] || problems "unable to determine deployment host"
SSH_HOST="${R_USER}@${ROOMBAHT_HOST}"
scp "$ENV_FILE" "${SSH_HOST}:${R_SECRET}"

if [ "$ACTION" == "init" ] ; then
    ROOM_FILE="$1"
    STAFF_FILE="$2"
    shift 2
    if [ ! -e "$ROOM_FILE" ] ; then
	problems "room file ${ROOM_FILE} not found"
    fi
    if [ ! -e "$STAFF_FILE" ] ; then
	problems "staff file ${STAFF_FILE} not found"
    fi
    ROOM_FILE="$(basename "$ROOM_FILE")"
    STAFF_FILE="$(basename "$STAFF_FILE")"
    ssh -o 'ControlMaster: no' \
	-t "$SSH_HOST" \
	"sudo bash /tmp/roombaht_ctl-remote.sh init '/tmp/${ROOM_FILE}' '/tmp/${STAFF_FILE}' ; sudo rm /tmp/roombaht_ctl-remote.sh"
elif [ "$ACTION" == "backend-log" ] ; then
    ssh -o 'ControlMaster: no' \
	-t "${SSH_HOST}" \
	"sudo journalctl -f -u roombaht -u cron.service -t roombaht-oob -t uwsgi -n 100"
elif [ "$ACTION" == "frontend-log" ] ; then
    ssh -o 'ControlMaster: no' \
	-t "$SSH_HOST" \
	"sudo tail -n 50 -f /var/log/nginx/access.log /var/log/nginx/error.log"
elif [ "$ACTION" == "backend-restart" ] ; then
    ssh -o 'ControlMaster: no' \
	-t "$SSH_HOST" \
	"sudo systemctl restart roombaht"
elif [ "$ACTION" == "wipe" ] || [ "$ACTION" == "clone_db" ] ; then
    echo "This will completely wipe the database and it will be super annoying to get it back."
    echo "Are you sure? [y/n]"
    read -r -s -n 1 answer
    if [ "$answer" != "y" ] ; then
	problems "user said no"
    fi
    if [ "$ACTION" == "clone_db" ] && [ "$R_ENV" == "prod" ] ; then
	problems "cannot clone prod -> prod"
    fi
    scp "${SCRIPTDIR}/roombaht_ctl-remote.sh" "${SSH_HOST}:${R_SCRIPT}"
    ssh -o 'ControlMaster: no' "${SSH_HOST}" \
	"sudo bash -c 'export ENV_FILE=${R_SECRET} ; bash ${R_SCRIPT} ${ACTION} $*'; sudo rm -f ${R_SCRIPT} ${R_SECRET}"
elif [ "$ACTION" == "manage" ] ; then
    scp "${SCRIPTDIR}/roombaht_ctl-remote.sh" "${SSH_HOST}:${R_SCRIPT}"
    ssh -o 'ControlMaster: no' \
	-t "${SSH_HOST}" \
	"sudo bash -c 'export ENV_FILE=${R_SECRET} ; bash ${R_SCRIPT} manage $*' ; sudo rm -f ${R_SCRIPT} ${R_SECRET}"
elif [ "$ACTION" == "help" ] ; then
    usage
else
    usage
    exit 1
fi
